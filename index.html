<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜ì—… ê¸°ë¡</title><!-- 1. ì œëª© ë³€ê²½ -->
    <style>
        /* 1. ê¸°ë³¸ ì„¤ì • ë° ëª¨ë°”ì¼ ìµœì í™” (S25 Ultra 412px ê¸°ì¤€) */
        body {
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: #343a40;
        }

        #app-container {
            max-width: 412px; /* ê°¤ëŸ­ì‹œ S25 Ultra ë“± í”Œë˜ê·¸ì‹­ ëª¨ë°”ì¼ ë„ˆë¹„ ê¸°ì¤€ */
            margin: 0 auto;
            padding: 15px;
            background-color: white;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            min-height: 100vh;
        }

        /* 2. ì œëª© ë° êµ¬ë¶„ì„  */
        h1, h2 {
            color: #007bff;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 5px;
            margin-top: 15px;
        }

        h1 { 
            margin-top: 0; 
            text-align: center;
            font-size: 1.8em;
            padding-bottom: 8px;
        } 

        hr {
            border: 0;
            border-top: 1px solid #dee2e6;
            margin: 20px 0;
        }

        /* 3. í¼ ë””ìì¸: í„°ì¹˜ ì¹œí™”ì  */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 6px;
            color: #495057;
            font-size: 0.95em;
        }

        input, select {
            width: 100%;
            padding: 10px;
            font-size: 0.9em;
            border: 1px solid #ced4da;
            border-radius: 6px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            border-color: #007bff;
            outline: none;
        }

        .flex-group {
            display: flex;
            gap: 10px;
        }
        .flex-group .half-width {
            flex: 1;
        }

        /* ì €ì¥ ë²„íŠ¼ */
        #save-button {
            width: 100%;
            padding: 14px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 5px;
        }

        #save-button:hover {
            background-color: #218838;
        }

        /* 7. ì‚¬ìš©ì í”¼ë“œë°± ë©”ì‹œì§€ */
        .feedback-message {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8d7da; /* Light red/error color (default for error) */
            color: #721c24; /* Dark red text */
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9em;
            transition: opacity 0.3s;
        }
        .feedback-message.success {
            background-color: #d4edda; /* Light green */
            color: #155724; /* Dark green */
            border-color: #c3e6cb;
        }


        /* 4. ì„ íƒ ì˜ì—­ (ë²„íŠ¼í˜• UI) */
        .selection-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            background-color: #f1f1f1;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #ced4da;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .toggle-btn {
            padding: 7px 10px;
            border-radius: 4px; /* ë³€ê²½: ì‚¬ê°í˜•ìœ¼ë¡œ í†µì¼ */
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
            user-select: none;
            text-align: center;
        }

        /* 3. ìˆ˜ì—… ë²„íŠ¼ (í•œ ì¤„) */
        #class-buttons {
            justify-content: space-between;
        }
        #class-buttons .toggle-btn {
            flex-grow: 1; /* ë³€ê²½: ê°„ê²©ì„ ì¼ì •í•˜ê²Œ ìœ ì§€í•˜ë©° í•œ ì¤„ì— ë°°ì¹˜ */
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 6px 4px; /* íŒ¨ë”© ì¡°ì • */
            font-size: 0.7em;
        }

        /* 2. í•™ìƒ ë²„íŠ¼ (ë‘ ì¤„ë¡œ ë‚˜ëˆ„ê¸° ìœ ë„) */
        #student-buttons {
            gap: 5px;
        }
        .student-btn {
            flex-grow: 1;
            flex-basis: auto; 
            min-width: 70px; /* ìµœì†Œ ë„ˆë¹„ ì„¤ì • */
            font-size: 0.75em;
            padding: 6px 8px;
            border-radius: 4px;
        }
        
        /* ê¸°ë¡ í•„í„° ë²„íŠ¼ë„ ì‚¬ê°í˜•ìœ¼ë¡œ í†µì¼ */
        #log-filter-buttons .toggle-btn {
             border-radius: 4px;
        }

        /* ì„ íƒë˜ì—ˆì„ ë•Œ ìŠ¤íƒ€ì¼ */
        .toggle-btn.active {
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,123,255,0.3);
        }
        
        .student-btn.active {
            background-color: #17a2b8;
            border-color: #117a8b;
        }

        .guide-text {
            font-size: 0.8em;
            color: #6c757d;
            text-align: left;
        }
        
        .section-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
            margin-top: 10px;
            font-weight: bold;
        }

        /* 5, 6. ê¸°ë¡ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ (2ì¤„ ë ˆì´ì•„ì›ƒ) */
        #log-list {
            list-style: none;
            padding: 0;
        }
        .log-item {
            background-color: #ffffff;
            border: 1px solid #e9ecef;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 1.0em; /* 3. ê¸€ê¼´ í¬ê¸° ì¦ê°€ */
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        /* 6. ì²« ì¤„: ë‚ ì§œ ë° ìš”ì¼ (ì‚­ì œ ì•„ì´ì½˜ í¬í•¨) */
        .log-date-group {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px dashed #e9ecef;
        }
        
        .log-entries-container {
            /* ê° ë¡œê·¸ ì—”íŠ¸ë¦¬ë“¤ì´ ì´ ì»¨í…Œì´ë„ˆ ì•ˆì— ë“¤ì–´ê°‘ë‹ˆë‹¤ */
        }

        /* New: ê° ê¸°ë¡ ë¬¸ì„œ (ìˆ˜ì—…/í•™ìƒ + ì‚­ì œ ë²„íŠ¼) */
        .log-entry {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 0;
            border-bottom: 1px dashed #f1f1f1;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        
        /* 2. ì‚­ì œ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
        .delete-log-icon {
            flex-shrink: 0;
            font-size: 1.1em;
            color: #dc3545;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
            opacity: 0.7;
        }
        .delete-log-icon:hover {
            background-color: #f8d7da;
            opacity: 1;
        }


        /* 6. ë‘ ë²ˆì§¸ ì¤„: ìˆ˜ì—… ì •ë³´ (ì™¼ìª½) + ì¶œì„ í•™ìƒ (ì˜¤ë¥¸ìª½) */
        .log-details {
            flex-grow: 1;
            min-width: 0;
            display: flex; 
            justify-content: space-between;
            align-items: center;
            font-size: 1.0em; /* 3. ê¸€ê¼´ í¬ê¸° ì¦ê°€ */
        }
        .log-class-entry {
            margin-left: 0 !important;
            font-weight: bold;
            color: #343a40;
            flex-shrink: 0;
        }
        .log-class-entry strong {
             color: #28a745;
             font-weight: bold;
        }
        .log-members {
            font-size: 0.95em; /* 3. ê¸€ê¼´ í¬ê¸° ì¦ê°€ */
            color: #6c757d;
            flex-shrink: 1;
            text-align: right;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            max-width: 55%; 
        }

        .empty-message {
            text-align: center;
            color: #aaa;
            padding: 20px;
        }
    </style>
</head>
<body>

<div id="app-container">
    <h1>ìˆ˜ì—… ê¸°ë¡</h1><!-- 1. ì œëª© ë³€ê²½ -->
    
    <!-- ì…ë ¥ í¼ ì˜ì—­ -->
    <div class="form-section">
        <div class="flex-group form-group">
            <div class="half-width">
                <label for="date">ë‚ ì§œ</label>
                <input type="date" id="date">
            </div>
            <div class="half-width">
                <label for="round">íšŒì°¨</label>
                <select id="round">
                    <option value="1">1íšŒì°¨</option>
                    <option value="2">2íšŒì°¨</option>
                    <option value="3">3íšŒì°¨</option>
                    <option value="4">4íšŒì°¨</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label>ìˆ˜ì—… ì„ íƒ</label>
            <div class="guide-text" style="text-align:left; margin-bottom:5px;">ìˆ˜ì—…ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ í•™ìƒë“¤ì´ ìë™ ì„ íƒë˜ë©°, ë‹¤ìŒ íšŒì°¨ê°€ ìë™ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤. (ì¤‘ë³µ ì„ íƒ ë¶ˆê°€)</div>
            
            <div class="selection-container" id="class-buttons">
                <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ìƒì„± -->
            </div>

            <div class="section-label">â–¼ ì¶œì„ í•™ìƒ</div>
            <div class="selection-container" id="student-buttons" style="background-color: #e9ecef;">
                <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ìƒì„± -->
            </div>
        </div>

        <button id="save-button">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
        <!-- FIX: ì‚¬ìš©ì í”¼ë“œë°±ì„ ìœ„í•œ ìš”ì†Œ ì¶”ê°€ -->
        <div id="user-feedback" class="feedback-message" style="display: none;"></div>
    </div>

    <hr>

    <!-- ê¸°ë¡ ë¦¬ìŠ¤íŠ¸ ì˜ì—­ -->
    <h2>ê¸°ë¡ ë‚´ì—­</h2>
    
    <!-- 4. ê¸°ë¡ ë‚´ì—­ í•„í„° í•­ëª© ì¶”ê°€ -->
    <div class="form-group">
        <label>ìˆ˜ì—…ë³„ ë‚´ì—­ ë³´ê¸°</label>
        <div class="selection-container" id="log-filter-buttons">
            <!-- í•„í„° ë²„íŠ¼ ìƒì„± -->
        </div>
    </div>
    
    <!-- 5. ì‚­ì œ ë²„íŠ¼ ì œê±°ë¨ -->

    <div id="status-message" class="empty-message">ë°ì´í„° ë¡œë”© ì¤‘...</div> 
    <ul id="log-list">
        <!-- Logs will be rendered here -->
    </ul>

</div>

<script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Set Firebase config and App ID (Globally available in Canvas environment)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    // FIX: ReferenceError í•´ê²°ì„ ìœ„í•´ initialAuthToken ë³€ìˆ˜ í• ë‹¹ ìˆ˜ì •
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app;
    let db;
    let auth;
    let userId = null;
    let logCollectionRef = null;
    let logs = []; // ì¸ë©”ëª¨ë¦¬ ë¡œê·¸ ë°°ì—´
    let activeLogFilter = null; // 2. ì´ˆê¸°ê°’ì„ nullë¡œ ì„¤ì •í•˜ì—¬ ì²˜ìŒì—ëŠ” ì•„ë¬´ê²ƒë„ ë³´ì—¬ì£¼ì§€ ì•ŠìŒ

    // --- ë°ì´í„° ì •ì˜ ---
    const classData = [
        { name: 'ê³ ìœ ë¦¬', members: ['ê³ ìœ ë¦¬'] },
        { name: 'ì„œí•˜íŒ€', members: ['ì†¡ì„œí•˜', 'ì˜¤ì—°ìš°', 'ì´ì±„í¬'] },
        { name: 'ì—°í¬íŒ€', members: ['ì†¡íƒœì£¼', 'ì„ì‹œì˜¨', 'í™©ì„œí˜„'] },
        { name: 'ì£¼ìŠ¹ë¯¼í˜•', members: ['ì£¼ìŠ¹ë¯¼í˜•'] },
        { name: 'êµ­í’€', members: ['êµ­í’€'] },
        { name: 'ìˆ˜í•™ê²½ì‹œ', members: ['ì†¡íƒœì£¼', 'ì„ì‹œì˜¨', 'ë¯¼ì±„ì•„'] }
    ];

    // ì¶œì„ í•™ìƒ ëª©ë¡ (ê³ ìœ ë¦¬, êµ­í’€, ì£¼ìŠ¹ë¯¼í˜• ì œì™¸)
    let allStudents = new Set();
    classData.forEach(c => {
        if (!['ê³ ìœ ë¦¬', 'êµ­í’€', 'ì£¼ìŠ¹ë¯¼í˜•'].includes(c.name)) {
             c.members.forEach(m => allStudents.add(m));
        }
    });
    allStudents = Array.from(allStudents).sort(); // ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬

    // --- Firebase ì´ˆê¸°í™” ë° ì¸ì¦ ---
    function initializeFirebase() {
        if (!firebaseConfig) {
            console.error("Firebase configuration is not available.");
            return;
        }

        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                logCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/tutoring_logs`);
                setupLogListener();
            } else {
                try {
                    // initialAuthTokenì„ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ ì‹œë„
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Sign-In Error:", error);
                    const statusMessageEl = document.getElementById('status-message');
                    if (statusMessageEl) {
                        statusMessageEl.innerText = "ë°ì´í„° ë¡œë”© ì‹¤íŒ¨ (ì¸ì¦ ì˜¤ë¥˜)";
                    }
                }
            }
        });
    }
    
    // --- Firebase ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
    function setupLogListener() {
        if (!logCollectionRef) return;
        
        const statusMessageEl = document.getElementById('status-message');
        if (!statusMessageEl) {
            console.error("Status message element not found.");
            return;
        }

        const logQuery = query(logCollectionRef);

        onSnapshot(logQuery, (snapshot) => {
            const fetchedLogs = [];
            snapshot.forEach(doc => {
                fetchedLogs.push({ id: doc.id, ...doc.data() });
            });
            // ìƒì„± ì‹œê°„ ì—­ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ìˆœ)
            logs = fetchedLogs.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
            
            renderLogs();
            
            // ë°ì´í„° ë¡œë”© í›„ ìƒíƒœ ë©”ì‹œì§€ ìˆ¨ê¹€ (null í•„í„° ì‹œì—ëŠ” renderLogsì—ì„œ ì²˜ë¦¬)
            if (activeLogFilter !== null) {
                statusMessageEl.style.display = 'none';
            }
        }, (error) => {
            console.error("Firestore Listener Error:", error);
            statusMessageEl.innerText = "ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ";
            statusMessageEl.style.display = 'block';
        });
    }

    // --- UI ìƒì„± ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('date').valueAsDate = new Date();
        initializeFirebase();
        createClassButtons();
        createStudentButtons();
        createLogFilterButtons(); // 4. í•„í„° ë²„íŠ¼ ìƒì„±
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
        document.getElementById('save-button').addEventListener('click', saveLog);
    });

    function createClassButtons() {
        const classContainer = document.getElementById('class-buttons');
        classData.forEach(item => {
            const btn = document.createElement('div');
            btn.className = 'toggle-btn';
            btn.innerText = item.name;
            btn.dataset.className = item.name;
            btn.addEventListener('click', () => toggleClass(btn)); // 3. ì¸ìë¡œ ë²„íŠ¼ë§Œ ë„˜ê¹€
            classContainer.appendChild(btn);
        });
    }

    function createStudentButtons() {
        const studentContainer = document.getElementById('student-buttons');
        allStudents.forEach(student => {
            const btn = document.createElement('div');
            btn.className = 'toggle-btn student-btn';
            btn.innerText = student;
            btn.dataset.name = student;
            btn.onclick = () => btn.classList.toggle('active');
            studentContainer.appendChild(btn);
        });
    }

    // 4. ê¸°ë¡ ë‚´ì—­ í•„í„° ë²„íŠ¼ ìƒì„±
    function createLogFilterButtons() {
        const filterContainer = document.getElementById('log-filter-buttons');
        // 'ì „ì²´' ì˜µì…˜ ì¶”ê°€
        const allClasses = [{ name: 'ì „ì²´', members: [] }, ...classData]; 

        allClasses.forEach(item => {
            const btn = document.createElement('div');
            btn.className = 'toggle-btn student-btn';
            btn.innerText = item.name;
            btn.dataset.filterName = item.name;
            btn.addEventListener('click', () => toggleLogFilter(btn, item.name));
            filterContainer.appendChild(btn);
        });
        
        // 2. ê¸°ë³¸ 'ì „ì²´' ì„ íƒ ë¡œì§ ì œê±° - activeLogFilterê°€ nullì´ë¯€ë¡œ ì´ˆê¸°ì—ëŠ” ì•„ë¬´ê²ƒë„ ì„ íƒí•˜ì§€ ì•ŠìŒ
    }

    // 2. ê¸°ë¡ ë‚´ì—­ í•„í„°ë§ ë¡œì§ (ìˆ˜ì •: ë‹¤ì‹œ í´ë¦­í•˜ë©´ í•´ì œ/ì•„ë¬´ê²ƒë„ í‘œì‹œ ì•ˆí•¨)
    function toggleLogFilter(btn, filterName) {
        const wasActive = btn.classList.contains('active');

        // 1. ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
        document.querySelectorAll('#log-filter-buttons .toggle-btn').forEach(b => b.classList.remove('active'));

        if (!wasActive) {
            // ìƒˆ ë²„íŠ¼ í™œì„±í™”
            btn.classList.add('active');
            activeLogFilter = filterName;
        } else {
            // ì´ë¯¸ í™œì„±í™”ëœ ë²„íŠ¼ì„ ë‹¤ì‹œ í´ë¦­í•˜ë©´ í•„í„° í•´ì œ (ì•„ë¬´ê²ƒë„ ì•ˆ ë³´ì—¬ì£¼ê¸°)
            activeLogFilter = null; 
        }

        renderLogs(); // í•„í„° ë³€ê²½ í›„ ê¸°ë¡ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    }


    // 3. ìˆ˜ì—… ì„ íƒ ë¡œì§ (ìƒí˜¸ ë°°íƒ€ì )
    function toggleClass(btn) {
        const className = btn.dataset.className;
        const classInfo = classData.find(c => c.name === className);
        if (!classInfo) return;
        const members = classInfo.members;

        const wasActive = btn.classList.contains('active');

        // 1. ëª¨ë“  ìˆ˜ì—… ë° í•™ìƒ ìƒíƒœ ì´ˆê¸°í™”
        document.querySelectorAll('#class-buttons .toggle-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.student-btn').forEach(b => b.classList.remove('active'));
        
        // 2. ì´ì „ì— í™œì„±í™”ë˜ì§€ ì•Šì•˜ë‹¤ë©´: í™œì„±í™”í•˜ê³  í•™ìƒ ì²´í¬, íšŒì°¨ ì„¤ì •
        if (!wasActive) {
            btn.classList.add('active');
            members.forEach(memberName => {
                const sBtn = document.querySelector(`.student-btn[data-name="${memberName}"]`);
                if (sBtn) sBtn.classList.add('active');
            });
            setNextRound(className);
        } 
        // 3. ì´ì „ì— í™œì„±í™”ëœ ìƒíƒœì˜€ë‹¤ë©´: ëª¨ë“  ê²ƒì´ ë¦¬ì…‹ë˜ì–´ ë¹„í™œì„±í™” ìƒíƒœê°€ ìœ ì§€ë¨ (ì„ íƒ í•´ì œ)
    }

    function setNextRound(className) {
        let nextRound = 1;
        
        const lastLog = logs.find(log => log.className === className); 
        
        if (lastLog) {
            // "XíšŒì°¨"ì—ì„œ Xë¥¼ ì¶”ì¶œ
            const lastRoundNum = parseInt(lastLog.round.replace('íšŒì°¨', '').trim());
            if (!isNaN(lastRoundNum)) {
                // 1, 2, 3, 4 ìˆœí™˜
                nextRound = (lastRoundNum % 4) + 1;
            }
        }
        
        document.getElementById('round').value = nextRound;
    }
    
    // --- Helper function for user feedback (FIX: UIì— ë©”ì‹œì§€ë¥¼ í‘œì‹œ) ---
    function showFeedback(message, type = 'error', duration = 3000) {
        const feedbackEl = document.getElementById('user-feedback');
        if (!feedbackEl) return;
        
        // Remove previous classes
        feedbackEl.classList.remove('success');
        
        // Set new content and class
        feedbackEl.innerText = message;
        feedbackEl.classList.add(type);
        feedbackEl.style.display = 'block';
        
        // Auto-hide
        setTimeout(() => {
            feedbackEl.style.display = 'none';
            feedbackEl.innerText = '';
        }, duration);
    }

    // --- ê¸°ë¡ ì €ì¥ (Firebase) ---
    async function saveLog() {
        // 1. Firebase ì—°ê²° í™•ì¸
        if (!logCollectionRef) {
            showFeedback("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", 'error', 5000);
            return;
        }

        const date = document.getElementById('date').value;
        const roundSelect = document.getElementById('round');
        const roundText = roundSelect.options[roundSelect.selectedIndex].text;
        
        const activeClassBtns = document.querySelectorAll('#class-buttons .toggle-btn.active');
        const activeStudentBtns = document.querySelectorAll('.student-btn.active');

        // 2. ìœ íš¨ì„± ê²€ì‚¬ (ì‚¬ìš©ì í”¼ë“œë°±ìœ¼ë¡œ ë³€ê²½)
        if (!date) {
            showFeedback("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.", 'error');
            return;
        }
        if (activeClassBtns.length === 0) {
            showFeedback("ìˆ˜ì—…ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.", 'error'); 
            return;
        }
        // ìƒí˜¸ ë°°íƒ€ì ì´ë¯€ë¡œ activeClassBtns.lengthëŠ” í•­ìƒ 1ì…ë‹ˆë‹¤.

        const selectedStudents = Array.from(activeStudentBtns).map(btn => btn.innerText);

        let success = true;
        
        // 3. ì„ íƒëœ ìˆ˜ì—…ë³„ë¡œ ë¡œê·¸ë¥¼ ë¶„ë¦¬í•˜ì—¬ ì €ì¥
        for (const btn of activeClassBtns) {
            const className = btn.dataset.className;
            const classMembers = classData.find(c => c.name === className).members;
            
            const attendedMembers = selectedStudents.filter(student => classMembers.includes(student));

            const newLog = {
                date: date, // YYYY-MM-DD
                round: roundText, // XíšŒì°¨
                className: className, // ê³ ìœ ë¦¬, ì„œí•˜íŒ€ ë“±
                members: attendedMembers, // [í•™ìƒ1, í•™ìƒ2]
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(logCollectionRef, newLog);
            } catch (error) {
                console.error("Error writing document: ", error);
                showFeedback(`ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error', 5000);
                success = false;
                break;
            }
        }
        
        // 4. ì„±ê³µ ì‹œ ì²˜ë¦¬
        if (success) {
            // í¼ ë¦¬ì…‹
            resetForm();
            showFeedback("ìˆ˜ì—… ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", 'success');
        }
    }
    
    // 2. ë‹¨ì¼ ë¡œê·¸ ì‚­ì œ ê¸°ëŠ¥
    async function deleteSingleLog(logId) {
        if (!logCollectionRef) {
            console.error("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¤‘ì…ë‹ˆë‹¤.");
            return;
        }
        
        try {
            await deleteDoc(doc(logCollectionRef, logId));
            showFeedback("ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", 'success', 2000);
        } catch (error) {
            console.error(`Error deleting document ${logId}:`, error);
            showFeedback("ê¸°ë¡ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", 'error', 5000);
        }
    }


    function resetForm() {
        const allBtns = document.querySelectorAll('.toggle-btn');
        allBtns.forEach(b => b.classList.remove('active'));

        document.getElementById('round').value = 1;
    }


    // --- ê¸°ë¡ ë‚´ì—­ í‘œì‹œ (ë‚ ì§œë³„ ê·¸ë£¹í™” ë° í•„í„°ë§) ---
    function renderLogs() {
        const listElement = document.getElementById('log-list');
        const statusMessageEl = document.getElementById('status-message');
        
        listElement.innerHTML = "";
        
        // 2. í•„í„°ê°€ nullì´ë©´ ì•„ë¬´ê²ƒë„ í‘œì‹œí•˜ì§€ ì•Šê³  ì¢…ë£Œ
        if (activeLogFilter === null) {
            if (statusMessageEl) statusMessageEl.style.display = 'none';
            return;
        }

        // í•„í„° ì ìš©
        const filteredLogs = activeLogFilter === 'ì „ì²´' 
            ? logs 
            : logs.filter(log => log.className === activeLogFilter);


        if (filteredLogs.length === 0) {
            if (statusMessageEl) {
                statusMessageEl.innerText = activeLogFilter === 'ì „ì²´' 
                    ? `ì•„ì§ ê¸°ë¡ëœ ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.` 
                    : `"${activeLogFilter}" ìˆ˜ì—… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.`;
                statusMessageEl.style.display = 'block';
            }
            return;
        }
        
        // ìƒíƒœ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
        if (statusMessageEl) statusMessageEl.style.display = 'none';

        // 1. ë¡œê·¸ë¥¼ ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”
        const groupedLogs = filteredLogs.reduce((acc, log) => {
            const date = log.date;
            if (!acc[date]) {
                acc[date] = [];
            }
            acc[date].push(log);
            return acc;
        }, {});

        // 2. ë‚ ì§œ (í‚¤)ë¥¼ ì—­ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹  ë‚ ì§œë¶€í„°)
        const sortedDates = Object.keys(groupedLogs).sort().reverse();

        // 3. UIì— ë°˜ì˜
        sortedDates.forEach(date => {
            const groupItem = document.createElement('li');
            groupItem.className = 'log-item';

            // ë‚ ì§œ í‘œì‹œ (YYë…„ MMì›” DDì¼ ìš”ì¼)
            const displayDate = new Date(date).toLocaleDateString('ko-KR', { 
                year: '2-digit', month: '2-digit', day: '2-digit', weekday: 'short' 
            }).replace(/\. /g, '.').replace(/\.$/, '');
            
            // ë‚ ì§œ ê·¸ë£¹ í—¤ë”
            groupItem.innerHTML = `<div class="log-date-group">ğŸ“… ${displayDate}</div>`;

            const entriesContainer = document.createElement('div');
            entriesContainer.className = 'log-entries-container';

            // ê° ìˆ˜ì—… ê¸°ë¡ í•­ëª© (2ì¤„)
            groupedLogs[date].forEach(log => {
                const memberList = log.members && log.members.length > 0 ? log.members.join(', ') : 'í•™ìƒ ì •ë³´ ì—†ìŒ';
                
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.dataset.id = log.id;
                
                logEntry.innerHTML = `
                    <div class="log-details">
                        <span class="log-class-entry">${log.className} (<strong>${log.round}</strong>)</span>
                        <span class="log-members">ì¶œì„: ${memberList}</span>
                    </div>
                    <span class="delete-log-icon" data-id="${log.id}" title="ê¸°ë¡ ì‚­ì œ">ğŸ—‘ï¸</span>
                `;
                entriesContainer.appendChild(logEntry);
            });
            
            groupItem.appendChild(entriesContainer);
            listElement.appendChild(groupItem);
        });

        // 2. Add listener for the delete icon on each entry (Event Delegation is better, but this is simple)
        listElement.querySelectorAll('.delete-log-icon').forEach(icon => {
            icon.addEventListener('click', (e) => {
                // í™•ì¸ ë©”ì‹œì§€ë¥¼ ì‚¬ìš©ìê°€ ì§ì ‘ ë³´ê²Œ í•´ì•¼ í•˜ë¯€ë¡œ window.confirmì„ ì‚¬ìš©
                if (window.confirm('ì´ ê¸°ë¡ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    const logId = e.currentTarget.dataset.id;
                    deleteSingleLog(logId);
                }
            });
        });
    }
</script>

</body>
</html>