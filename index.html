<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜ì—… ê¸°ë¡</title>
    <style>
        /* 1. ê¸°ë³¸ ì„¤ì • ë° ëª¨ë°”ì¼ ìµœì í™” */
        body {
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: #343a40;
        }

        #app-container {
            max-width: 412px;
            margin: 0 auto;
            padding: 15px;
            background-color: white;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            min-height: 100vh;
        }

        /* 2. ì œëª© ë° êµ¬ë¶„ì„  */
        h1, h2 {
            color: #007bff;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 5px;
            margin-top: 15px;
        }

        h1 { 
            margin-top: 0; 
            text-align: center;
            font-size: 1.8em;
            padding-bottom: 8px;
        } 

        hr {
            border: 0;
            border-top: 1px solid #dee2e6;
            margin: 20px 0;
        }

        /* 3. í¼ ë””ìì¸ */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 6px;
            color: #495057;
            font-size: 0.95em;
        }

        input, select {
            width: 100%;
            padding: 10px;
            font-size: 0.9em;
            border: 1px solid #ced4da;
            border-radius: 6px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            border-color: #007bff;
            outline: none;
        }

        .flex-group {
            display: flex;
            gap: 10px;
        }
        .flex-group .half-width {
            flex: 1;
        }

        /* ì €ì¥ ë²„íŠ¼ */
        #save-button {
            width: 100%;
            padding: 14px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 5px;
        }

        #save-button:hover {
            background-color: #218838;
        }

        #save-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* í”¼ë“œë°± ë©”ì‹œì§€ */
        .feedback-message {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9em;
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
        }
        .feedback-message.success {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        .feedback-message.warning {
            background-color: #fff3cd;
            color: #856404;
            border-color: #ffeeba;
        }

        /* 4. ì„ íƒ ì˜ì—­ (ë²„íŠ¼í˜• UI) */
        .selection-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            background-color: #f1f1f1;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #ced4da;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .toggle-btn {
            padding: 7px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
            user-select: none;
            text-align: center;
        }

        /* ìˆ˜ì—… ë²„íŠ¼ */
        #class-buttons {
            justify-content: space-between;
        }
        #class-buttons .toggle-btn {
            flex-grow: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 6px 4px;
            font-size: 0.7em;
        }

        /* í•™ìƒ ë²„íŠ¼ */
        #student-buttons {
            gap: 5px;
        }
        .student-btn {
            flex-grow: 1;
            flex-basis: auto; 
            min-width: 70px;
            font-size: 0.75em;
            padding: 6px 8px;
            border-radius: 4px;
        }
        
        #log-filter-buttons .toggle-btn {
             border-radius: 4px;
        }

        /* ì„ íƒë˜ì—ˆì„ ë•Œ ìŠ¤íƒ€ì¼ */
        .toggle-btn.active {
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,123,255,0.3);
        }
        
        .student-btn.active {
            background-color: #17a2b8;
            border-color: #117a8b;
        }

        .guide-text {
            font-size: 0.8em;
            color: #6c757d;
            text-align: left;
        }
        
        .section-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
            margin-top: 10px;
            font-weight: bold;
        }

        /* 5. ê¸°ë¡ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ */
        #log-list {
            list-style: none;
            padding: 0;
        }
        .log-item {
            background-color: #ffffff;
            border: 1px solid #e9ecef;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 1.0em;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .log-date-group {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px dashed #e9ecef;
        }
        
        .log-entry {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0; /* íŒ¨ë”© ì•½ê°„ ì¦ê°€ */
            border-bottom: 1px dashed #f1f1f1;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        
        /* ì‚­ì œ ì•„ì´ì½˜ */
        .delete-log-icon {
            flex-shrink: 0;
            font-size: 1.2em; /* í„°ì¹˜í•˜ê¸° ì¢‹ê²Œ ì•½ê°„ í‚¤ì›€ */
            color: #dc3545;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%; /* ì›í˜• í„°ì¹˜ ì˜ì—­ */
            transition: background-color 0.2s;
            opacity: 0.8;
        }
        .delete-log-icon:hover {
            background-color: #f8d7da;
            opacity: 1;
        }

        .log-details {
            flex-grow: 1;
            min-width: 0;
            display: flex; 
            justify-content: space-between;
            align-items: center;
            font-size: 1.0em;
        }
        .log-class-entry {
            margin-left: 0 !important;
            font-weight: bold;
            color: #343a40;
            flex-shrink: 0;
            margin-right: 8px;
        }
        .log-class-entry strong {
             color: #28a745;
             font-weight: bold;
        }
        
        /* í•™ìƒ ì´ë¦„ ìŠ¤íƒ€ì¼ */
        .log-members {
            font-size: 0.8em; /* ê¸€ì í¬ê¸° ì¶•ì†Œ */
            color: #6c757d;
            flex-shrink: 1;
            text-align: right;
            
            /* ì¤„ë°”ê¿ˆ í—ˆìš© */
            white-space: normal; 
            word-break: keep-all; /* ë‹¨ì–´ ë‹¨ìœ„ë¡œ ì¤„ë°”ê¿ˆ */
            line-height: 1.3;
            
            max-width: 60%; 
        }

        .empty-message {
            text-align: center;
            color: #aaa;
            padding: 20px;
        }

        /* ì‚­ì œ í™•ì¸ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none; /* JSë¡œ ì œì–´ */
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 80%;
            max-width: 320px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .modal-text {
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            flex: 1;
        }
        .modal-btn.confirm {
            background-color: #dc3545;
            color: white;
        }
        .modal-btn.cancel {
            background-color: #e9ecef;
            color: #495057;
        }
    </style>
</head>
<body>

<div id="app-container">
    <h1>ìˆ˜ì—… ê¸°ë¡</h1>
    
    <!-- ì…ë ¥ í¼ ì˜ì—­ -->
    <div class="form-section">
        <div class="flex-group form-group">
            <div class="half-width">
                <label for="date">ë‚ ì§œ</label>
                <input type="date" id="date">
            </div>
            <div class="half-width">
                <label for="round">íšŒì°¨</label>
                <select id="round">
                    <option value="1">1íšŒì°¨</option>
                    <option value="2">2íšŒì°¨</option>
                    <option value="3">3íšŒì°¨</option>
                    <option value="4">4íšŒì°¨</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label>ìˆ˜ì—… ì„ íƒ</label>
            <div class="guide-text" style="text-align:left; margin-bottom:5px;">ìˆ˜ì—…ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ í•™ìƒë“¤ì´ ìë™ ì„ íƒë˜ë©°, ë‹¤ìŒ íšŒì°¨ê°€ ìë™ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤.</div>
            
            <div class="selection-container" id="class-buttons">
                <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ìƒì„± -->
            </div>

            <div class="section-label">â–¼ ì¶œì„ í•™ìƒ</div>
            <div class="selection-container" id="student-buttons" style="background-color: #e9ecef;">
                <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ìƒì„± -->
            </div>
        </div>

        <button id="save-button" disabled>ì´ˆê¸°í™” ì¤‘...</button>
        <div id="user-feedback" class="feedback-message"></div>
    </div>

    <hr>

    <!-- ê¸°ë¡ ë¦¬ìŠ¤íŠ¸ ì˜ì—­ -->
    <h2>ê¸°ë¡ ë‚´ì—­</h2>
    
    <div class="form-group">
        <label>ìˆ˜ì—…ë³„ ë‚´ì—­ ë³´ê¸°</label>
        <div class="selection-container" id="log-filter-buttons">
            <!-- í•„í„° ë²„íŠ¼ ìƒì„± -->
        </div>
    </div>
    
    <div id="status-message" class="empty-message">ë°ì´í„° ë¡œë”© ì¤‘...</div> 
    <ul id="log-list">
        <!-- Logs will be rendered here -->
    </ul>

</div>

<!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div id="delete-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-text">ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
        <div class="modal-buttons">
            <button id="cancel-delete" class="modal-btn cancel">ì·¨ì†Œ</button>
            <button id="confirm-delete" class="modal-btn confirm">ì‚­ì œ</button>
        </div>
    </div>
</div>

<script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ------------------------------------------------------------------
    // 1. ìº”ë²„ìŠ¤ í™˜ê²½ ìë™ ê°ì§€ (ìˆ˜ì •í•  í•„ìš” ì—†ìŒ)
    // ------------------------------------------------------------------
    const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const envAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // ------------------------------------------------------------------
    // 2. ì™¸ë¶€ ë°°í¬(Vercel ë“±)ìš© ìˆ˜ë™ ì„¤ì •
    // **ìº”ë²„ìŠ¤ì—ì„œëŠ” ì•„ë˜ ê°’ì„ ì…ë ¥í•˜ì§€ ì•Šì•„ë„ ì‘ë™í•©ë‹ˆë‹¤!**
    // **Vercel ë°°í¬ ì‹œì—ë§Œ ì•„ë˜ ê°’ì„ ì±„ì›Œì£¼ì„¸ìš”.**
    // ------------------------------------------------------------------
    const manualConfig = {
        apiKey: "",              
        authDomain: "",
        projectId: "",
        storageBucket: "",
        messagingSenderId: "",
        appId: ""
    };
    // ------------------------------------------------------------------

    let app, db, auth;
    let userId = null;
    let logCollectionRef = null;
    let logs = []; 
    let activeLogFilter = 'ì „ì²´'; 
    let deleteTargetId = null;

    // --- ë°ì´í„° ì •ì˜ ---
    const classData = [
        { name: 'ê³ ìœ ë¦¬', members: ['ê³ ìœ ë¦¬'] },
        { name: 'ì„œí•˜íŒ€', members: ['ì†¡ì„œí•˜', 'ì˜¤ì—°ìš°', 'ì´ì±„í¬'] },
        { name: 'ì—°í¬íŒ€', members: ['ì†¡íƒœì£¼', 'ì„ì‹œì˜¨', 'í™©ì„œí˜„'] },
        { name: 'ì£¼ìŠ¹ë¯¼í˜•', members: ['ì£¼ìŠ¹ë¯¼í˜•'] },
        { name: 'êµ­í’€', members: ['êµ­í’€'] },
        { name: 'ìˆ˜í•™ê²½ì‹œ', members: ['ì†¡íƒœì£¼', 'ì„ì‹œì˜¨', 'ë¯¼ì±„ì•„'] }
    ];

    let allStudents = new Set();
    classData.forEach(c => {
        if (!['ê³ ìœ ë¦¬', 'êµ­í’€', 'ì£¼ìŠ¹ë¯¼í˜•'].includes(c.name)) {
             c.members.forEach(m => allStudents.add(m));
        }
    });
    allStudents = Array.from(allStudents).sort();

    // --- ì•± ì‹œì‘ ---
    startApp();

    function startApp() {
        document.getElementById('date').valueAsDate = new Date();
        createClassButtons();
        createStudentButtons();
        createLogFilterButtons();
        setupModalEvents();
        
        document.getElementById('save-button').addEventListener('click', saveLog);
        
        // Firebase ì´ˆê¸°í™” ì‹œì‘
        initializeFirebase();
    }

    // --- Firebase ì´ˆê¸°í™” (ìˆ˜ì •ë¨) ---
    function initializeFirebase() {
        const saveBtn = document.getElementById('save-button');
        const statusMsg = document.getElementById('status-message');

        // 1. ì‚¬ìš©í•  ì„¤ì • ê²°ì • (ìº”ë²„ìŠ¤ í™˜ê²½ ìš°ì„ )
        let configToUse = null;

        if (envConfig) {
            // ìº”ë²„ìŠ¤ í™˜ê²½
            configToUse = envConfig;
        } else if (manualConfig.apiKey && manualConfig.apiKey !== "") {
            // Vercel ë“± ì™¸ë¶€ í™˜ê²½ (ìˆ˜ë™ ì„¤ì •ì´ ìˆì„ ë•Œ)
            configToUse = manualConfig;
        }

        // 2. ì„¤ì •ì´ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬ (Vercel ë°°í¬ ì§í›„ ë“±)
        if (!configToUse) {
            console.warn("Firebase ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.");
            saveBtn.innerText = "ì„¤ì • í•„ìš” (Vercel ë°°í¬ ì‹œ ì½”ë“œ ìˆ˜ì •)";
            saveBtn.disabled = true; // ì €ì¥ë§Œ ë§‰ê³  ì•±ì€ ì‹¤í–‰
            
            showFeedback("Vercel ë°°í¬ ì‹œ ì½”ë“œ ë‚´ 'manualConfig' ê°’ì„ ì±„ì›Œì£¼ì„¸ìš”.", 'warning', 8000);
            statusMsg.innerText = "ì„¤ì •ì´ ì—†ì–´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            return;
        }

        // 3. Firebase ì´ˆê¸°í™” ì§„í–‰
        try {
            app = initializeApp(configToUse);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // ë¡œê·¸ì¸ ì„±ê³µ
                    userId = user.uid;
                    // ì•± IDë„ í™˜ê²½ì— ë”°ë¼ ë‹¤ë¥´ê²Œ ì ìš©
                    const currentAppId = envConfig ? envAppId : "my-class-log-app";
                    
                    logCollectionRef = collection(db, `artifacts/${currentAppId}/users/${userId}/tutoring_logs`);
                    
                    saveBtn.disabled = false;
                    saveBtn.innerText = 'ê¸°ë¡ ì €ì¥í•˜ê¸°';
                    
                    setupLogListener();
                } else {
                    // ë¡œê·¸ì¸ ì‹œë„
                    try {
                        if (initialAuthToken) {
                             // ìº”ë²„ìŠ¤ í™˜ê²½ ì „ìš© ì¸ì¦
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // ì¼ë°˜ ìµëª… ì¸ì¦
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Login Error:", error);
                        saveBtn.innerText = "ë¡œê·¸ì¸ ì‹¤íŒ¨";
                        showFeedback("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message, 'error');
                    }
                }
            });
        } catch (e) {
            console.error("Firebase Init Error:", e);
            saveBtn.innerText = "ì´ˆê¸°í™” ì˜¤ë¥˜";
            showFeedback("Firebase ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", 'error');
        }
    }
    
    // --- Firestore ë¦¬ìŠ¤ë„ˆ ---
    function setupLogListener() {
        if (!logCollectionRef) return;
        
        const statusMessageEl = document.getElementById('status-message');
        const logQuery = query(logCollectionRef);

        onSnapshot(logQuery, (snapshot) => {
            const fetchedLogs = [];
            snapshot.forEach(doc => {
                fetchedLogs.push({ id: doc.id, ...doc.data() });
            });
            // ìµœì‹ ìˆœ ì •ë ¬
            logs = fetchedLogs.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
            
            // UI ê°±ì‹ 
            renderLogs();
            
        }, (error) => {
            console.error("Firestore Error:", error);
            if (statusMessageEl) statusMessageEl.innerText = "ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ";
        });
    }

    // ëª¨ë‹¬ ì´ë²¤íŠ¸
    function setupModalEvents() {
        const modal = document.getElementById('delete-modal');
        const confirmBtn = document.getElementById('confirm-delete');
        const cancelBtn = document.getElementById('cancel-delete');

        cancelBtn.addEventListener('click', () => {
            modal.style.display = 'none';
            deleteTargetId = null;
        });

        confirmBtn.addEventListener('click', () => {
            if (deleteTargetId) {
                deleteSingleLog(deleteTargetId);
                modal.style.display = 'none';
                deleteTargetId = null;
            }
        });
    }

    function createClassButtons() {
        const classContainer = document.getElementById('class-buttons');
        classData.forEach(item => {
            const btn = document.createElement('div');
            btn.className = 'toggle-btn';
            btn.innerText = item.name;
            btn.dataset.className = item.name;
            btn.addEventListener('click', () => toggleClass(btn));
            classContainer.appendChild(btn);
        });
    }

    function createStudentButtons() {
        const studentContainer = document.getElementById('student-buttons');
        allStudents.forEach(student => {
            const btn = document.createElement('div');
            btn.className = 'toggle-btn student-btn';
            btn.innerText = student;
            btn.dataset.name = student;
            btn.onclick = () => btn.classList.toggle('active');
            studentContainer.appendChild(btn);
        });
    }

    function createLogFilterButtons() {
        const filterContainer = document.getElementById('log-filter-buttons');
        const allClasses = [{ name: 'ì „ì²´', members: [] }, ...classData]; 

        allClasses.forEach(item => {
            const btn = document.createElement('div');
            btn.className = 'toggle-btn student-btn';
            btn.innerText = item.name;
            
            if (item.name === 'ì „ì²´') btn.classList.add('active');
            
            btn.addEventListener('click', () => toggleLogFilter(btn, item.name));
            filterContainer.appendChild(btn);
        });
    }

    function toggleLogFilter(btn, filterName) {
        if (btn.classList.contains('active')) return;

        document.querySelectorAll('#log-filter-buttons .toggle-btn').forEach(b => b.classList.remove('active'));

        btn.classList.add('active');
        activeLogFilter = filterName;

        renderLogs();
    }

    function toggleClass(btn) {
        const className = btn.dataset.className;
        const classInfo = classData.find(c => c.name === className);
        if (!classInfo) return;
        
        const wasActive = btn.classList.contains('active');

        document.querySelectorAll('#class-buttons .toggle-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.student-btn').forEach(b => b.classList.remove('active'));
        
        if (!wasActive) {
            btn.classList.add('active');
            classInfo.members.forEach(memberName => {
                const sBtn = document.querySelector(`.student-btn[data-name="${memberName}"]`);
                if (sBtn) sBtn.classList.add('active');
            });
            setNextRound(className);
        } 
    }

    function setNextRound(className) {
        let nextRound = 1;
        const lastLog = logs.find(log => log.className === className); 
        
        if (lastLog) {
            const lastRoundNum = parseInt(lastLog.round.replace('íšŒì°¨', '').trim());
            if (!isNaN(lastRoundNum)) {
                nextRound = (lastRoundNum % 4) + 1; 
            }
        }
        document.getElementById('round').value = nextRound;
    }
    
    function showFeedback(message, type = 'error', duration = 3000) {
        const feedbackEl = document.getElementById('user-feedback');
        if (!feedbackEl) return;
        
        feedbackEl.className = 'feedback-message'; 
        feedbackEl.classList.remove('success', 'error', 'warning'); // ê¸°ì¡´ í´ë˜ìŠ¤ ì œê±°
        feedbackEl.classList.add(type);
        feedbackEl.innerText = message;
        feedbackEl.style.display = 'block';
        
        setTimeout(() => {
            feedbackEl.style.display = 'none';
        }, duration);
    }

    // --- ê¸°ë¡ ì €ì¥ ---
    async function saveLog() {
        if (!userId || !logCollectionRef) {
            showFeedback("ë¡œê·¸ì¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...", 'error');
            return;
        }

        const date = document.getElementById('date').value;
        const roundSelect = document.getElementById('round');
        const roundText = roundSelect.options[roundSelect.selectedIndex].text;
        
        const activeClassBtn = document.querySelector('#class-buttons .toggle-btn.active');
        const activeStudentBtns = document.querySelectorAll('.student-btn.active');

        if (!date) {
            showFeedback("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.", 'error');
            return;
        }
        if (!activeClassBtn) {
            showFeedback("ìˆ˜ì—…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", 'error'); 
            return;
        }

        const className = activeClassBtn.dataset.className;
        const selectedStudents = Array.from(activeStudentBtns).map(btn => btn.innerText);
        
        const newLog = {
            date: date,
            round: roundText,
            className: className,
            members: selectedStudents,
            timestamp: serverTimestamp()
        };

        try {
            await addDoc(logCollectionRef, newLog);
            showFeedback("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!", 'success');
            resetForm();
        } catch (error) {
            console.error("Save Error:", error);
            showFeedback(`ì €ì¥ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }
    
    async function deleteSingleLog(logId) {
        if (!logCollectionRef) return;
        try {
            await deleteDoc(doc(logCollectionRef, logId));
            showFeedback("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", 'success', 2000);
        } catch (error) {
            console.error("Delete Error:", error);
            showFeedback("ì‚­ì œ ì‹¤íŒ¨ (ê¶Œí•œ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤)", 'error');
        }
    }

    function resetForm() {
        document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('round').value = 1;
    }

    // --- ê¸°ë¡ ë Œë”ë§ ---
    function renderLogs() {
        const listElement = document.getElementById('log-list');
        const statusMessageEl = document.getElementById('status-message');
        
        listElement.innerHTML = "";
        
        const filteredLogs = activeLogFilter === 'ì „ì²´' 
            ? logs 
            : logs.filter(log => log.className === activeLogFilter);

        if (filteredLogs.length === 0) {
            if (statusMessageEl) {
                statusMessageEl.innerText = activeLogFilter === 'ì „ì²´' 
                    ? "ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤." 
                    : `"${activeLogFilter}" ìˆ˜ì—… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.`;
                statusMessageEl.style.display = 'block';
            }
            return;
        }
        
        if (statusMessageEl) statusMessageEl.style.display = 'none';

        const groupedLogs = filteredLogs.reduce((acc, log) => {
            const date = log.date;
            if (!acc[date]) acc[date] = [];
            acc[date].push(log);
            return acc;
        }, {});

        const sortedDates = Object.keys(groupedLogs).sort().reverse();

        sortedDates.forEach(date => {
            const groupItem = document.createElement('li');
            groupItem.className = 'log-item';

            const displayDate = new Date(date).toLocaleDateString('ko-KR', { 
                year: '2-digit', month: '2-digit', day: '2-digit', weekday: 'short' 
            }).replace(/\. /g, '.').replace(/\.$/, '');
            
            groupItem.innerHTML = `<div class="log-date-group">ğŸ“… ${displayDate}</div>`;

            const entriesContainer = document.createElement('div');
            entriesContainer.className = 'log-entries-container';

            groupedLogs[date].forEach(log => {
                const memberList = log.members && log.members.length > 0 ? log.members.join(', ') : '-';
                
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                
                logEntry.innerHTML = `
                    <div class="log-details">
                        <span class="log-class-entry">${log.className} (<strong>${log.round}</strong>)</span>
                        <span class="log-members">ì¶œì„: ${memberList}</span>
                    </div>
                    <span class="delete-log-icon" title="ê¸°ë¡ ì‚­ì œ">ğŸ—‘ï¸</span>
                `;
                
                // ì‚­ì œ ëª¨ë‹¬ ì—´ê¸°
                const deleteIcon = logEntry.querySelector('.delete-log-icon');
                deleteIcon.addEventListener('click', () => {
                    deleteTargetId = log.id;
                    document.getElementById('delete-modal').style.display = 'flex';
                });

                entriesContainer.appendChild(logEntry);
            });
            
            groupItem.appendChild(entriesContainer);
            listElement.appendChild(groupItem);
        });
    }
</script>

</body>
</html>